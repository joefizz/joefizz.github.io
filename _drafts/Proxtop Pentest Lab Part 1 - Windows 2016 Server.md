---
layout: post
title: Proxtop Pentest Lab Part 1 - Windows Server 2016
subtitle: oh here comes this guy - wooooooooo
bigimg: /img/window-ghost.jpg
tags: [network, ipv6, ntlmrelayx, pentest]
date: 2019-11-27 
---

Now that the Proxtop has a basic setup and network config ready to go it's time to start loading on our hosts.  We'll start with the server.

Windows Server 2019 is now available however I'm going with 2016.  It's good to have your lab on common releases and to be honest in the real world i'm still mostly seeing 2012 deployments with a few 2016 and 2008 scattered around so even having 2016 in our lab might be a bit advanced!

Microsoft now provides 180 day trials of their server software which is plenty enough for us to run with in our lab.  They also provide 90 day trials of desktop software which will be handy for Part 2.  Once the 180/90 days expire I think there's not much limitation and just some prompts on the screen, I guess we'll find out next year some time.

Download Windows Server 2016 ISO from the official Microsoft repo [here](https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016/).  You need to enter some details before you download but there is no verification.

Once ISO is downloaded upload to the host storage on `pve` using the Upload button within Content

<p align="center">
<img src="{{site.url}}/img/proxmox-storage-content.jpg" alt="drawing" width="800" class="center"/>
</p>

For the VM setup Proxmox has a best practice guide for Server 2016 deployment [here](https://pve.proxmox.com/wiki/Windows_2016_guest_best_practices)] and also a video narrated by text to speech [here](https://www.proxmox.com/en/training/video-tutorials/item/install-windows-2016-server-on-proxmox-ve).  There are guide for other OS's as well in case you've decided to go off piste.

### VM Creation

So to begin click the Create VM button in the top right corner of the Proxmox web GUI and you'll be presented with this window:

<p align="center">
<img src="{{site.url}}/img/proxmox-create-vm.jpg" alt="drawing" width="800" class="center"/>
</p>

By default the Advanced box isn't ticked so tick that to see the extra options.  I'm not going to go through every option in this window, only the things that will be adjusted.

1.  **General**

    `Node` - we only have the one option here.  If we had more devices in our Datacenter we could choose which to deploy to
 
    `VM ID` - your choice here.  I'm sticking with the default 100
 
    `Name` - something sensible.  In my case i'm going with *server01*

1.  **OS**
   
    Here should be straight forward.  Choose the ISO that you uploaded in the last step and set the Guest OS options appropriately.

1.  **System**

    `Qemu Agent` - make sure you tick this box.  We'll need this in our installation.

    Leave everything else as default

1.  **Hard Disk**

    `Bus/Device` - Set Bus to `SCSI`

    `Cache` - Set this to `Write back`.  The default is a bit safer but also slower.

    `Disk size (GiB)` - Sert this appropriately.  We are setting up our server with GUI and all the tools.  From experience we could probably get away with the default 32GiB here but we've got plenty of space in our lab so will push it out to 60 in case we want to add anything down the line.

1.  **CPU**

    `Cores` - always good to have a minimum of 2 cores.  Honestly have no idea how many are on my physical processor but we'll choose 2 here.  Leave Sockets at 1.  You can if you wish choose 2 Sockets and 1 core, the underlying KVM will end up doing the same thing anyway.

1.  **Memory**

    `Memory (MiB) - This needs to be enough but not too much.  We have 16GB in total and need to share this between the host OS, our single server, and our two desktops.  Might also be dropping an attacking guest in here so be weary of that.  For now 4GB (approx 4096 MiB) should be plenty for our server.

1.  **Network**

    `Model` - Choose *VirtIO (paravirtualised)*

1.  **Confirm**

    Make sure you've got everything as above(below) and then click on Finish

<p align="center">
<img src="{{site.url}}/img/proxmox-server-confirm.jpg" alt="drawing" width="800" class="center"/>
</p>

### OS Install

So now the VM has been created and will be visible under the `pve` node in the Server View.  Before launching we need to grab the VirtIO drivers so that we're ready to add these to the server.  The driver ISO can be downloaded from [here](https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html#virtio-win-direct-downloads).  At time of writing I downloaded the [Stable virtio-win](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso) ISO. 

Once this is downloaded it needs to be stored on the host just like we've done with the OS ISOs.  We then need to virtually install it in our VM.  We already have or OS install DVD in one drive so we'll need to create a second drive for the driver ISO.  In the Hardware options for our server click on Add > CD/DVD Drive.  Choose Bus IDE and Device 3 along with selecting the drive ISO:

<p align="center">
<img src="{{site.url}}/img/proxmox-server-dvd.jpg" alt="drawing" width="400" class="center"/>
</p>

And then click on Create to complete.

Now it's time to launch our first VM.  How exciting!

To launch our server first select it from the Server View tree and click on the Start button.  You can then click on the Console button to view the server via noVNC

<p align="center">
<img src="{{site.url}}/img/proxmox-server-start.jpg" alt="drawing" width="800" class="center"/>
</p>

Click through a couple of screens choosing sensible options.  When you get to the screen to choose the OS you want to choose a Standard Evaluation (Desktop Experience).  Datacenter includes a lot more support for Hyper-V stuff which we don't need.  The non Desktop Experience options literally don't have a desktop and need to be managed remotely, don't do this.

Keep going until you get to the screen which gives the options for Upgrade or Custom.  **Choose Custom** as this is where we need to add our VirtIO drivers.

You'll get a screen like this:

<p align="center">
<img src="{{site.url}}/img/proxmox-server-driver.jpg" alt="drawing" width="800" class="center"/>
</p>

Click on *Load driver* and hopefully you'll see a screen with a list of controller drivers.  If not check you have added the virtual DVD correctly.

Choose the `Red Hat VirtIO SCSI pass-through controller (E:\amd64\2k8\vioscsi.inf)` option and click on Next.  This will make the virtual hard disk visible to Windows.  

It is also necessary to load drivers for the network interface, and for memory ballooning. To do this you must again click on Load driver and then rather that choosing one of the options displayed, click on Browse and go through the file system to select the appropriate driver.  This must be done twice as there are two drivers to select so ensure you complete the process by selecting the valid driver and then clicking Next before returning to Load driver:

`e:\NetKVM\2k16\amd64` for the network driver

`e:\balloon\2k16\amd64` for the memory ballooning driver

Once these are both done click on Next in the disk window.  The installer will now progress with the installation, go grab a coffee.

### Server 2016 Configuration

So on this server we are going to want to setup the following services:

    Active Directory
    DNS
    DHCP


